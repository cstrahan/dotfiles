- name: Get current user id
  ansible.builtin.command: id -un
  become: false
  changed_when: false
  register: current_user
  when: target_user is not defined

- name: Set target_user fact
  ansible.builtin.set_fact:
    target_user: "{{ target_user | default(current_user.stdout) }}"

- name: Get user info
  ansible.builtin.getent:
    database: passwd
    key: "{{ target_user }}"

- name: Set user_home fact
  ansible.builtin.set_fact:
    user_home: "{{ ansible_facts.getent_passwd[target_user][4] }}"

- name: Install system packages
  ansible.builtin.apt:
    name:
      - zsh
      - bfs
    state: present

- name: Check if zsh is installed and executable
  ansible.builtin.stat:
    path: /usr/bin/zsh
  register: zsh_binary

- name: Set zsh as default shell
  ansible.builtin.user:
    name: "{{ target_user }}"
    shell: /usr/bin/zsh
  when:
    - zsh_binary.stat.exists and zsh_binary.stat.executable
    - ansible_facts.getent_passwd[target_user][5] != '/usr/bin/zsh'

- name: Create .local/bin directory
  ansible.builtin.file:
    path: "{{ user_home }}/.local/bin"
    state: directory
    mode: '0755'
  become: true
  become_user: "{{ target_user }}"

- name: Install uv for user
  ansible.builtin.shell: curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    creates: "{{ user_home }}/.local/bin/uv"
  become: true
  become_user: "{{ target_user }}"

- name: Install rustup for user
  ansible.builtin.shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  args:
    creates: "{{ user_home }}/.cargo/bin/rustup"
  become: true
  become_user: "{{ target_user }}"

- name: Install fzf
  ansible.builtin.shell: |
    set -e
    curl -fsSL https://github.com/junegunn/fzf/releases/download/v0.66.0/fzf-0.66.0-linux_amd64.tar.gz -o /tmp/fzf.tar.gz
    tar -xzf /tmp/fzf.tar.gz -C {{ user_home }}/.local/bin
    rm /tmp/fzf.tar.gz
  args:
    creates: "{{ user_home }}/.local/bin/fzf"
  become: true
  become_user: "{{ target_user }}"

- name: Install neovim
  ansible.builtin.shell: |
    set -e
    curl -fsSL https://github.com/neovim/neovim/releases/download/v0.11.5/nvim-linux-x86_64.tar.gz -o /tmp/nvim.tar.gz
    tar -xzf /tmp/nvim.tar.gz -C {{ user_home }}/.local
    ln -sf {{ user_home }}/.local/nvim-linux-x86_64/bin/nvim {{ user_home }}/.local/bin/nvim
    rm /tmp/nvim.tar.gz
  args:
    creates: "{{ user_home }}/.local/bin/nvim"
  become: true
  become_user: "{{ target_user }}"

- name: Install aqua
  ansible.builtin.shell: |
    set -e
    curl -fsSL https://raw.githubusercontent.com/aquaproj/aqua-installer/v4.0.2/aqua-installer -o /tmp/aqua-installer
    chmod +x /tmp/aqua-installer
    /tmp/aqua-installer
    rm /tmp/aqua-installer
  args:
    creates: "{{ user_home }}/.local/share/aquaproj-aqua/bin/aqua"
  become: true
  become_user: "{{ target_user }}"

- name: Install mise for user
  ansible.builtin.shell: curl https://mise.run | sh
  args:
    creates: "{{ user_home }}/.local/bin/mise"
  become: true
  become_user: "{{ target_user }}"

- name: Clone and setup dotfiles
  ansible.builtin.shell: |
    set -e
    GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=accept-new" git clone git@github.com:cstrahan/dotfiles.git /tmp/dotfiles-clone
    mv /tmp/dotfiles-clone/.git {{ user_home }}/.git
    cd {{ user_home }}
    git --git-dir={{ user_home }}/.git --work-tree={{ user_home }} reset --hard HEAD
    rm -rf /tmp/dotfiles-clone
  args:
    creates: "{{ user_home }}/.git"
  become: true
  become_user: "{{ target_user }}"

- name: Install atuin for user
  ansible.builtin.shell: curl --proto '=https' --tlsv1.2 -LsSf https://setup.atuin.sh | sh
  args:
    creates: "{{ user_home }}/.atuin/bin/atuin"
  become: true
  become_user: "{{ target_user }}"

- name: Install kitty terminfo
  ansible.builtin.shell: |
    set -e
    curl -fsSL https://raw.githubusercontent.com/kovidgoyal/kitty/master/terminfo/kitty.terminfo -o /tmp/kitty.terminfo
    tic -x -o /usr/share/terminfo /tmp/kitty.terminfo
    rm /tmp/kitty.terminfo
  args:
    creates: /usr/share/terminfo/x/xterm-kitty

- name: Check if ghostty terminfo exists
  ansible.builtin.stat:
    path: /usr/share/terminfo/x/xterm-ghostty
  register: ghostty_terminfo

- name: Copy ghostty terminfo to remote
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/assets/xterm-ghostty.terminfo"
    dest: /tmp/xterm-ghostty.terminfo
    mode: '0644'
  when: not ghostty_terminfo.stat.exists

- name: Install ghostty terminfo
  ansible.builtin.shell: |
    set -e
    tic -x -o /usr/share/terminfo /tmp/xterm-ghostty.terminfo
    rm /tmp/xterm-ghostty.terminfo
  when: not ghostty_terminfo.stat.exists

- name: Configure global aqua tools with mise
  ansible.builtin.shell: ~/.local/bin/mise use --global aqua:fd aqua:ripgrep aqua:bat aqua:delta aqua:lsd
  become: true
  become_user: "{{ target_user }}"
  args:
    creates: "{{ user_home }}/.config/mise/config.toml"
